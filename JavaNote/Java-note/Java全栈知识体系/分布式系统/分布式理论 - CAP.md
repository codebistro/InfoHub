# 分布式理论 - CAP

> CAP理论是分布式系统、特别是分布式存储领域中被讨论的最多的理论。其中C代表一致性 (Consistency)，A代表可用性 (Availability)，P代表分区容错性 (Partition tolerance)。CAP理论告诉我们C、A、P三者不能同时满足，最多只能满足其中两个。 

- 分布式理论 - CAP
  - CAP 理论简介
    - [CAP 三选二](#cap-三选二)
    - [对CAP理论的理解](#对cap理论的理解)
    - [CAP理论深入理解](#cap理论深入理解)
  - [参考文章](#参考文章)

##  CAP 理论简介

CAP理论是分布式系统、特别是分布式存储领域中被讨论的最多的理论。其中**C代表一致性 (Consistency)，A代表可用性 (Availability)，P代表分区容错性 (Partition tolerance)**。CAP理论告诉我们C、A、P三者不能同时满足，最多只能满足其中两个。

![img](img/img_%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA%20-%20CAP/arch-cap-1.png)

###  CAP 三选二

- `一致性 (Consistency)`: 一个写操作返回成功，那么之后的读请求都必须读到这个新数据；如果返回失败，那么所有读操作都不能读到这个数据。所有节点访问同一份最新的数据。
- `可用性 (Availability)`: 对数据更新具备高可用性，请求能够及时处理，不会一直等待，即使出现节点失效。
- `分区容错性 (Partition tolerance)`: 能容忍网络分区，在网络断开的情况下，被分隔的节点仍能正常对外提供服务。

### 什么是CAP理论√

CAP 原则又称CAP 定理，指的是在一个分布式系统中:

- **一致性，Consistency**：**数据一致更新，所有数据变动都是同步的（强一致性）**。在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访问同一份最新的数据副本）

- **可用性，Availability**：好的响应性能。在**集群中一部分节点故障后**，集群整体是否**还能及时响应客户端的读写请求。**（对数据更新具备高可用性）

- **分区容错性，Partition tolerance** ： **能容忍网络分区，在网络断开的情况下，被分隔的节点仍能正常对外提供服务。** 大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。

定理：任何分布式系统**最多只可同时满足二点**，没法三者兼顾。



##### 补充：

> 一般来说，分区容错无法避免，因此可以认为CAP 的P 总是成立。CAP 定理告诉我们，剩下的C 和A 无法同时做到。
> 分布式系统中实现一致性的raft 算法、paxos
> http://thesecretlivesofdata.com/raft/

CA系统（放弃P）：指将所有数据（或者仅仅是那些与事务相关的数据）都放在一个分布式节点上，就不会存在网络分区。所以强一致性以及可用性得到满足。

CP系统（放弃A）：如果要求数据在各个服务器上是强一致的，然而网络分区会导致同步时间无限延长，那么如此一来可用性就得不到保障了。坚持事务ACID（原子性、一致性、隔离性和持久性）的传统数据库以及对结果一致性非常敏感的应用通常会做出这样的选择。

AP系统（放弃C）：这里所说的放弃一致性，并不是完全放弃数据一致性，而是**放弃数据的强一致性，而保留数据的最终一致性。**如果即要求系统高可用又要求分区容错，那么就要放弃一致性了。因为一旦发生网络分区，节点之间将无法通信，为了满足高可用，每个节点只能用本地数据提供服务，这样就会导致数据不一致。一些遵守BASE原则数据库，（如：Cassandra、CouchDB等）往往会放宽对一致性的要求（满足最终一致性即可），一次来获取基本的可用性。

> 对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到99.99999%（N 个9），即保证P 和A，舍弃C。

###  对CAP理论的理解

理解CAP理论最简单的方式是想象两个副本处于分区两侧，即两个副本之间的网络断开，不能通信。

- 如果允许其中一个副本更新，则会导致数据不一致，即丧失了C性质。
- 如果为了保证一致性，将分区某一侧的副本设置为不可用，那么又丧失了A性质。
- 除非两个副本可以互相通信，才能既保证C又保证A，这又会导致丧失P性质。

一般来说使用网络通信的分布式系统，无法舍弃P性质，那么就只能在一致性和可用性上做一个艰难的选择。

> CAP理论的表述很好地服务了它的目的，开阔了分布式系统设计者的思路，在多样化的取舍方案下设计出多样化的系统。在过去的十几年里确实涌现了不计其数的新系统，也随之在一致性和可用性的相对关系上产生了相当多的争论。

###  CAP理论深入理解

在CAP理论提出十二年之后，其作者又出来辟谣。“三选二”的公式一直存在着误导性，它会过分简单化各性质之间的相互关系:

- 首先，由于分区很少发生，那么在系统不存在分区的情况下没什么理由牺牲C或A。
- 其次，C与A之间的取舍可以在同一系统内以非常细小的粒度反复发生，而每一次的决策可能因为具体的操作，乃至因为牵涉到特定的数据或用户而有所不同。
- 最后，这三种性质都可以在程度上衡量，并不是非黑即白的有或无。可用性显然是在0%到100%之间连续变化的，一致性分很多级别，连分区也可以细分为不同含义，如系统内的不同部分对于是否存在分区可以有不一样的认知。

所以一致性和可用性并不是水火不容，非此即彼的。Paxos、Raft等分布式一致性算法就是在一致性和可用性之间做到了很好的平衡的见证。

##  参考文章

-  原文链接：https://pdai.tech/md/dev-spec/spec/dev-th-cap.html

- https://zhuanlan.zhihu.com/p/31727291

------

